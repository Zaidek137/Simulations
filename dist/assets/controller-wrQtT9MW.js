const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index.es-DNc-Kwos.js","assets/index-BQlDc_X7.js","assets/framer-motion-BLeoVWJg.js","assets/react-vendor-hc9cV1gX.js","assets/d3-vendor-DXMZTTbz.js","assets/supabase-vendor-CzrfDcjy.js","assets/index-D4d2cgjb.css"])))=>i.map(i=>d[i]);
import{g as W,a as E,N as S,n as I,b as f,s as $,_ as F,D as z,c as y,f as G,d as P,e as V,h as T,p as J,i as K,v as X,j as Y,k as B,u as Q,l as v,t as Z}from"./index-BQlDc_X7.js";import{U as H,S as x}from"./rpc-2aTLlUJJ.js";import"./framer-motion-BLeoVWJg.js";import"./react-vendor-hc9cV1gX.js";import"./d3-vendor-DXMZTTbz.js";import"./supabase-vendor-CzrfDcjy.js";let w=null;const _={lastUsedChainId:"tw.wc.lastUsedChainId",requestedChains:"tw.wc.requestedChains"};async function pn(n,s,e,a,i){const c=await R(n,e,i),o=n.walletConnect;let{onDisplayUri:t}=o||{};const r=await E(e);!t&&i&&(t=U=>{const D=r.mobile.native||r.mobile.universal;if(!D){i(U);return}const k=G(D,U).redirect;i(k)}),t&&c.events.addListener("display_uri",t);let d=o?.optionalChains,l=n.chain;e==="global.safe"&&(d=O.map(f),l&&!d.includes(l)&&(l=void 0));const{chains:h,rpcMap:p}=sn({chain:l,client:n.client,optionalChains:d});await c.connect({...o?.pairingTopic?{pairingTopic:o?.pairingTopic}:{},optionalNamespaces:{[S]:{chains:h,events:["chainChanged","accountsChanged"],methods:["eth_sendTransaction","eth_signTransaction","eth_sign","personal_sign","eth_signTypedData","eth_signTypedData_v4","wallet_switchEthereumChain","wallet_addEthereumChain"],rpcMap:p}}}),M(h.map(g=>Number(g.split(":")[1])),a);const u=h[0]?.split(":")[1]||1,m=I(u),A=an(c.session,"eip155:1");if(!A)throw new Error("No accounts found on provider.");const j=n.chain&&n.chain.id===m?n.chain:f(m);if(n){const g={chain:n.chain,optionalChains:n.walletConnect?.optionalChains,pairingTopic:n.walletConnect?.pairingTopic};a&&$(a,e,g)}return t&&c.events.removeListener("display_uri",t),L(A,j,c,s,a,n.client,r,i)}async function nn(n,s,e){if(!n.session)throw new Error("No session found on provider.");const a=`eip155:${s.id}`,i=v(s.id);if(N(n.session,a)){n.setDefaultChain(a);return}try{await C({provider:n,payload:{method:"wallet_switchEthereumChain",params:[{chainId:i}]},chain:a,walletInfo:e}),n.setDefaultChain(a);return}catch(o){if((o?.code??o?.data?.originalError?.code)===4001)throw new Error("User rejected chain switch")}const c=en(n.session);if(!c)throw new Error("No routable chain to send wallet_addEthereumChain");try{await C({provider:n,payload:{method:"wallet_addEthereumChain",params:[{chainId:i,chainName:s.name,nativeCurrency:s.nativeCurrency,rpcUrls:[s.rpc],blockExplorerUrls:[s.blockExplorers?.[0]?.url??""]}]},chain:c,walletInfo:e})}catch(o){throw(o?.code??o?.data?.originalError?.code)===4001?new Error("User rejected add chain"):new Error(`Add chain failed: ${o?.message||String(o)}`)}if(await C({provider:n,payload:{method:"wallet_switchEthereumChain",params:[{chainId:i}]},chain:a,walletInfo:e}),n.setDefaultChain(a),!N(n.session,a))throw new Error("Target chain still not enabled by wallet")}function b(n){return n?.namespaces?.eip155}function N(n,s){return!!b(n)?.accounts?.some(a=>a.startsWith(`${s}:`))}function an(n,s){const e=b(n),a=e?.accounts?.find(i=>i.startsWith(`${s}:`))||e?.accounts[0];return a?a.split(":")[2]??null:null}function en(n){return b(n)?.accounts?.[0]?.split(":")?.slice(0,2)?.join(":")??null}async function mn(n,s,e,a,i){const c=a?await W(a,e):null,o=await E(e),t=await R(c?{chain:c.chain,client:n.client,walletConnect:{optionalChains:c.optionalChains,pairingTopic:c.pairingTopic}}:{client:n.client,walletConnect:{}},e,i);if(!t.session)throw await t.disconnect(),new Error("No wallet connect session found on provider.");const d=t.session?.namespaces?.[S]?.accounts?.[0]?.split(":")[2];if(!d)throw new Error("No accounts found on provider.");const l=n.chain?.id||1,h=I(l),p=n.chain&&n.chain.id===h?n.chain:f(h);return L(d,p,t,s,a,n.client,o,i)}async function R(n,s,e){if(w)return w;const a=await E(s),i=n.walletConnect,{UniversalProvider:c}=await F(async()=>{const{UniversalProvider:d}=await import("./index.es-DNc-Kwos.js");return{UniversalProvider:d}},__vite__mapDeps([0,1,2,3,4,5,6]));let o=i?.optionalChains,t=n.chain;s==="global.safe"&&(o=O.map(f),t&&!o.includes(t)&&(t=void 0));const r=await c.init({metadata:{description:i?.appMetadata?.description||y().description,icons:[i?.appMetadata?.logoUrl||y().logoUrl],name:i?.appMetadata?.name||y().name,url:i?.appMetadata?.url||y().url,redirect:{native:a.mobile.native||void 0,universal:a.mobile.universal||void 0}},projectId:i?.projectId||z});if(r.events.setMaxListeners(Number.POSITIVE_INFINITY),s!=="walletConnect"){async function d(){const l=r.session?.peer?.metadata?.redirect?.native||a.mobile.native||a.mobile.universal;e&&l&&await e(l)}r.on("session_request_sent",d),r.events.addListener("disconnect",()=>{r.off("session_request_sent",d),w=null})}return w=r,r}function q({provider:n,address:s,client:e,chain:a,sessionRequestHandler:i,walletInfo:c}){return{address:T(s),async sendTransaction(t){const r=await C({provider:n,payload:{method:"eth_sendTransaction",params:[{data:t.data,from:T(s),gas:t.gas?v(t.gas):void 0,to:t.to,value:t.value?v(t.value):void 0}]},chain:`eip155:${t.chainId}`,walletInfo:c,sessionRequestHandler:i});return Z({chainId:t.chainId,client:e,contractAddress:t.to??void 0,gasPrice:t.gasPrice,transactionHash:r,walletAddress:T(s),walletType:"walletConnect"}),{transactionHash:r}},async signMessage({message:t}){const r=typeof t=="string"?B(t):t.raw instanceof Uint8Array?Q(t.raw):t.raw;return C({provider:n,payload:{method:"personal_sign",params:[r,this.address]},chain:`eip155:${a.id}`,walletInfo:c,sessionRequestHandler:i})},async signTypedData(t){const r=J(t),{domain:d,message:l,primaryType:h}=r,p={EIP712Domain:K({domain:d}),...r.types};X({domain:d,message:l,primaryType:h,types:p});const u=Y({domain:d??{},message:l,primaryType:h,types:p});return await C({provider:n,payload:{method:"eth_signTypedData_v4",params:[this.address,u]},chain:`eip155:${a.id}`,walletInfo:c,sessionRequestHandler:i})}}}async function C(n){const{provider:s,payload:e,chain:a,walletInfo:i,sessionRequestHandler:c}=n,o=s.request(e,a),t=s.session?.peer?.metadata?.redirect?.native||i.mobile.native||i.mobile.universal;return c&&t&&await c(t),o}function L(n,s,e,a,i,c,o,t){const r=q({address:n,chain:s,client:c,provider:e,sessionRequestHandler:t,walletInfo:o});async function d(){e.removeListener("accountsChanged",h),e.removeListener("chainChanged",p),e.removeListener("disconnect",l),await e.disconnect(),w=null}function l(){M([],i),i?.removeItem(_.lastUsedChainId),d(),a.emit("disconnect",void 0)}function h(u){if(u[0]){const m=q({address:T(u[0]),chain:s,client:c,provider:e,sessionRequestHandler:t,walletInfo:o});a.emit("accountChanged",m),a.emit("accountsChanged",u)}else l()}function p(u){const m=f(I(u));a.emit("chainChanged",m),i?.setItem(_.lastUsedChainId,String(u))}return e.on("accountsChanged",h),e.on("chainChanged",p),e.on("disconnect",l),e.on("session_delete",l),[r,s,d,u=>tn(e,u,o)]}async function tn(n,s,e){try{await nn(n,s,e)}catch(a){const i=typeof a=="string"?a:a?.message;throw/user rejected request/i.test(i)?new H(a):new x(a)}}function M(n,s){s?.setItem(_.requestedChains,V(n))}function sn(n){const s={},e=[];n.chain&&(s[n.chain.id]=P({chain:n.chain,client:n.client}),e.push(n.chain.id));const a=(n?.optionalChains||[]).slice(0,10);for(const i of a)s[i.id]=P({chain:i,client:n.client}),e.push(i.id);return e.includes(1)||(s[1]=f(1).rpc,e.push(1)),{chains:e.map(i=>`eip155:${i}`),rpcMap:s}}const O=[1,11155111,42161,43114,8453,1313161554,84532,56,42220,100,10,137,1101,324,534352];export{mn as autoConnectWC,pn as connectWC};
//# sourceMappingURL=controller-wrQtT9MW.js.map
