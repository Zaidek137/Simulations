const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/eth_getTransactionCount-BxjMZr-s.js","assets/index-Bbs9zcGG.js","assets/framer-motion-BLeoVWJg.js","assets/react-vendor-hc9cV1gX.js","assets/d3-vendor-DXMZTTbz.js","assets/supabase-vendor-CzrfDcjy.js","assets/index-DTWOheA7.css","assets/in-app-wallet-calls-DKYLOsJB.js","assets/send-batch-transaction-CahnqzXr.js"])))=>i.map(i=>d[i]);
import{bL as d,c2 as p,e as h,c3 as P,ag as M,c4 as S,b,h as f,_ as I,p as j,aP as R,ae as A,t as _,aL as L,K as G,c5 as k,c6 as $,c7 as D,c8 as x,c9 as E,ca as Q,cb as q,cc as V}from"./index-Bbs9zcGG.js";import{signLoginPayload as H}from"./sign-login-payload-BKykauFw.js";import{e as F}from"./eth_sendRawTransaction-DPdnXbFR.js";import"./framer-motion-BLeoVWJg.js";import"./react-vendor-hc9cV1gX.js";import"./d3-vendor-DXMZTTbz.js";import"./supabase-vendor-CzrfDcjy.js";const v=new Map,J={getItem:async i=>v.get(i)??null,removeItem:async i=>{v.delete(i)},setItem:async(i,e)=>{v.set(i,e)}};async function W({authToken:i,client:e,ecosystem:t}){const r=await d(e,t)(`${p("inAppWallet")}/api/2024-05-05/accounts`,{headers:{Authorization:`Bearer embedded-wallet-token:${i}`,"Content-Type":"application/json"},method:"GET"});if(!r.ok){const c=await r.text().catch(()=>"Unknown error");throw new Error(`Failed to get user info: ${c}`)}return await r.json()}const Y=p("inAppWallet"),K=`${Y}/`,N=`${K}api/2023-10-20`,X=`${N}/embedded-wallet/validate-custom-jwt`,Z=`${N}/embedded-wallet/validate-custom-auth-endpoint`,U=(i,e)=>e instanceof Error?`${i}: ${e.message}`:`${i}: ${h(e)}`;async function ee(i){const t=await d(i.client,i.ecosystem)(Z,{body:h({developerClientId:i.client.clientId,payload:i.payload}),headers:{"Content-Type":"application/json"},method:"POST"});if(!t.ok){const a=await t.json();throw new Error(`Custom auth endpoint authentication error: ${a.message}`)}try{const{verifiedToken:a}=await t.json();return{storedToken:a}}catch(a){throw new Error(U("Malformed response from post auth_endpoint authentication",a))}}async function te(i){const e=d(i.client,i.ecosystem),t=P({authOption:"backend",client:i.client,ecosystem:i.ecosystem}),a=await e(`${t}`,{body:h({walletSecret:i.walletSecret}),headers:{"Content-Type":"application/json"},method:"POST"});if(!a.ok){const r=await a.text();throw new Error(`Failed to generate backend account: ${r}`)}return await a.json()}async function ae(i){let e=await i.storage.getGuestSessionId();e||(e=M(32),i.storage.saveGuestSessionId(e));const t=d(i.client,i.ecosystem),a=S({authOption:"guest",client:i.client,ecosystem:i.ecosystem}),r=await t(`${a}`,{body:h({sessionId:e}),headers:{"Content-Type":"application/json"},method:"POST"});if(!r.ok){const c=await r.text();throw new Error(`Failed to generate guest account: ${r.status} ${r.statusText} ${c}`)}return await r.json()}async function ie(i){const t=await d(i.client,i.ecosystem)(X,{body:h({developerClientId:i.client.clientId,jwt:i.jwt}),headers:{"Content-Type":"application/json"},method:"POST"});if(!t.ok){const a=await t.json();throw new Error(`JWT authentication error: ${a.message}`)}try{const{verifiedToken:a}=await t.json();return{storedToken:a}}catch(a){throw new Error(U("Malformed response from post jwt authentication",a))}}async function ne({client:i,ecosystem:e,tokenToLink:t,storage:a}){const r=d(i,e),c=p("inAppWallet"),s=await a.getAuthCookie();if(!s)throw new Error("Failed to link account, no user logged in");const n={Authorization:`Bearer iaw-auth-token:${s}`,"Content-Type":"application/json"},l=await r(`${c}/api/2024-05-05/account/connect`,{body:h({accountAuthTokenToConnect:t}),headers:n,method:"POST"});if(!l.ok){const u=await l.json();throw new Error(u.message||"Failed to link account.")}const{linkedAccounts:o}=await l.json();return o??[]}async function se({client:i,ecosystem:e,profileToUnlink:t,allowAccountDeletion:a=!1,storage:r}){const c=d(i,e),s=p("inAppWallet"),n=await r.getAuthCookie();if(!n)throw new Error("Failed to unlink account, no user logged in");const l={Authorization:`Bearer iaw-auth-token:${n}`,"Content-Type":"application/json"},o=await c(`${s}/api/2024-05-05/account/disconnect`,{body:h({allowAccountDeletion:a,details:t.details,type:t.type}),headers:l,method:"POST"});if(!o.ok){const w=await o.json();throw new Error(w.message||"Failed to unlink account.")}const{linkedAccounts:u}=await o.json();return u??[]}async function re({client:i,ecosystem:e,storage:t}){const a=d(i,e),r=p("inAppWallet"),c=await t.getAuthCookie();if(!c)throw new Error("Failed to get linked accounts, no user logged in");const s={Authorization:`Bearer iaw-auth-token:${c}`,"Content-Type":"application/json"},n=await a(`${r}/api/2024-05-05/accounts`,{headers:s,method:"GET"});if(!n.ok){const o=await n.json();throw new Error(o.message||"Failed to get linked accounts.")}const{linkedAccounts:l}=await n.json();return l??[]}function B(){return`${p("inAppWallet")}/api/2024-05-05/login/passkey/callback`}function z(i,e){return`${p("inAppWallet")}/api/2024-05-05/login/passkey?type=${i}${e?`&username=${e}`:""}`}async function oe(i){if(!i.passkeyClient.isAvailable())throw new Error("Passkeys are not available on this device");const e=d(i.client,i.ecosystem),t=i.username??le(i.ecosystem),r=await(await e(z("sign-up",t))).json();if(!r.challenge)throw new Error("No challenge received");const c=r.challenge,s=await i.passkeyClient.register({challenge:c,name:t,rp:i.rp}),n={};i.ecosystem?.partnerId&&(n["x-ecosystem-partner-id"]=i.ecosystem.partnerId),i.ecosystem?.id&&(n["x-ecosystem-id"]=i.ecosystem.id);const o=await(await e(B(),{body:h({authenticatorData:s.authenticatorData,clientData:s.clientData,credential:{algorithm:s.credential.algorithm,publicKey:s.credential.publicKey},credentialId:s.credentialId,origin:s.origin,rpId:i.rp.id,serverVerificationId:r.serverVerificationId,type:"sign-up",username:t}),headers:{"Content-Type":"application/json",...n},method:"POST"})).json();if(!o||!o.storedToken)throw new Error(`Error verifying passkey: ${o.message??"unknown error"}`);return await i.storage?.savePasskeyCredentialId(s.credentialId),o}async function ce(i){if(!i.passkeyClient.isAvailable())throw new Error("Passkeys are not available on this device");const e=d(i.client,i.ecosystem),[t,a]=await Promise.all([e(z("sign-in")).then(o=>o.json()),i.storage?.getPasskeyCredentialId()]);if(!t.challenge)throw new Error("No challenge received");const r=t.challenge,c=await i.passkeyClient.authenticate({challenge:r,credentialId:a??void 0,rp:i.rp}),s={};i.ecosystem?.partnerId&&(s["x-ecosystem-partner-id"]=i.ecosystem.partnerId),i.ecosystem?.id&&(s["x-ecosystem-id"]=i.ecosystem.id);const l=await(await e(B(),{body:h({authenticatorData:c.authenticatorData,clientData:c.clientData,credentialId:c.credentialId,origin:c.origin,rpId:i.rp.id,serverVerificationId:t.serverVerificationId,signature:c.signature,type:"sign-in"}),headers:{"Content-Type":"application/json",...s},method:"POST"})).json();if(!l||!l.storedToken)throw new Error(`Error verifying passkey: ${l.message??"unknown error"}`);return await i.storage?.savePasskeyCredentialId(c.credentialId),l}function le(i){return`${i?.id??"wallet"}-${new Date().toISOString()}`}const ue=["xyz.abs"];async function de(i){const{wallet:e,client:t,ecosystem:a,chain:r}=i,c=ue.includes(e.id)?r||b(1):b(1),s=e.getAccount()||await e.connect({chain:c,client:t}),n=d(t,a),l=await(async()=>{const w=P({authOption:"wallet",client:i.client,ecosystem:i.ecosystem}),g=await n(`${w}&address=${s.address}&chainId=${c.id}`);if(!g.ok)throw new Error("Failed to generate SIWE login payload");return await g.json()})(),{signature:o}=await H({account:s,payload:l});return await(async()=>{const w=S({authOption:"wallet",client:i.client,ecosystem:i.ecosystem}),g=await n(`${w}&signature=${o}&payload=${encodeURIComponent(l)}`,{body:h({payload:l,signature:o}),headers:{"Content-Type":"application/json"},method:"POST"});if(!g.ok)throw new Error("Failed to verify SIWE signature");return await g.json()})()}async function he({client:i,payload:e,storage:t}){const a=await t.getAuthCookie(),r=t.ecosystem,c=d(i,r);if(!a)throw new Error("No auth token found when signing message");const s={address:e.address,chainId:e.chainId,nonce:Number(e.nonce)},n=await c(`${p("inAppWallet")}/api/v1/enclave-wallet/sign-authorization`,{body:h(s),headers:{Authorization:`Bearer embedded-wallet-token:${a}`,"Content-Type":"application/json","x-thirdweb-client-id":i.clientId},method:"POST"});if(!n.ok)throw new Error(`Failed to sign message - ${n.status} ${n.statusText}`);return await n.json()}async function we({client:i,payload:{message:e,isRaw:t,originalMessage:a,chainId:r},storage:c}){const s=await c.getAuthCookie(),n=c.ecosystem,l=d(i,n);if(!s)throw new Error("No auth token found when signing message");const o=await l(`${p("inAppWallet")}/api/v1/enclave-wallet/sign-message`,{body:h({messagePayload:{chainId:r,isRaw:t,message:e,originalMessage:a}}),headers:{Authorization:`Bearer embedded-wallet-token:${s}`,"Content-Type":"application/json","x-thirdweb-client-id":i.clientId},method:"POST"});if(!o.ok)throw new Error(`Failed to sign message - ${o.status} ${o.statusText}`);return await o.json()}async function pe({client:i,payload:e,storage:t}){const a=await t.getAuthCookie(),r=t.ecosystem,c=d(i,r);if(!a)throw new Error("No auth token found when signing transaction");const s=await c(`${p("inAppWallet")}/api/v1/enclave-wallet/sign-transaction`,{body:h({transactionPayload:e}),headers:{Authorization:`Bearer embedded-wallet-token:${a}`,"Content-Type":"application/json","x-thirdweb-client-id":i.clientId},method:"POST"});if(!s.ok)throw new Error(`Failed to sign transaction - ${s.status} ${s.statusText}`);return(await s.json()).signature}async function ge({client:i,payload:e,storage:t}){const a=await t.getAuthCookie(),r=t.ecosystem,c=d(i,r);if(!a)throw new Error("No auth token found when signing typed data");const s=await c(`${p("inAppWallet")}/api/v1/enclave-wallet/sign-typed-data`,{body:h({...e}),headers:{Authorization:`Bearer embedded-wallet-token:${a}`,"Content-Type":"application/json","x-thirdweb-client-id":i.clientId},method:"POST"});if(!s.ok)throw new Error(`Failed to sign typed data - ${s.status} ${s.statusText}`);return await s.json()}class me{constructor({client:e,ecosystem:t,address:a,storage:r}){Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"address",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=e,this.ecosystem=t,this.address=a,this.localStorage=r}async postWalletSetUp(e){await this.localStorage.saveAuthCookie(e.storedToken.cookieString)}async getUserWalletStatus(){const e=await this.localStorage.getAuthCookie();if(!e)return{status:"Logged Out"};const t=await W({authToken:e,client:this.client,ecosystem:this.ecosystem});if(!t)return{status:"Logged Out"};const a=t.wallets[0],r={email:t.linkedAccounts.find(c=>c.details.email!==void 0)?.details.email,phoneNumber:t.linkedAccounts.find(c=>c.details.phone!==void 0)?.details.phone,recoveryShareManagement:"ENCLAVE",userWalletId:t.id||""};return a?{account:await this.getAccount(),authDetails:r,status:"Logged In, Wallet Initialized",walletAddress:a.address}:{authDetails:r,status:"Logged In, Wallet Uninitialized"}}async getAccount(){const e=this.client,t=this.localStorage,a=this.address,r=this.ecosystem,c=async n=>{const l=A({chain:b(n.chainId),client:e}),o={chainId:L(n.chainId),data:n.data,gas:m(n.gas),nonce:m(n.nonce)||L(await I(async()=>{const{eth_getTransactionCount:u}=await import("./eth_getTransactionCount-BxjMZr-s.js");return{eth_getTransactionCount:u}},__vite__mapDeps([0,1,2,3,4,5,6])).then(({eth_getTransactionCount:u})=>u(l,{address:f(this.address),blockTag:"pending"}))),to:n.to?f(n.to):void 0,value:m(n.value)};return n.authorizationList&&n.authorizationList.length>0?(o.type=4,o.authorizationList=n.authorizationList,o.maxFeePerGas=m(n.maxFeePerGas),o.maxPriorityFeePerGas=m(n.maxPriorityFeePerGas)):m(n.maxFeePerGas)?(o.maxFeePerGas=m(n.maxFeePerGas),o.maxPriorityFeePerGas=m(n.maxPriorityFeePerGas),o.type=2):(o.gasPrice=m(n.gasPrice),o.type=0),pe({client:e,payload:o,storage:t})},s={address:f(a),async sendTransaction(n){const l=A({chain:b(n.chainId),client:e}),o=await c(n),u=await F(l,o);return _({chainId:n.chainId,client:e,contractAddress:n.to??void 0,ecosystem:r,gasPrice:n.gasPrice,transactionHash:u,walletAddress:a,walletType:"inApp"}),{transactionHash:u}},async signAuthorization(n){const l=await he({client:e,payload:n,storage:t});return{address:f(l.address),chainId:Number.parseInt(l.chainId),nonce:BigInt(l.nonce),r:BigInt(l.r),s:BigInt(l.s),yParity:Number.parseInt(l.yParity)}},async signMessage({message:n,originalMessage:l,chainId:o}){const u=typeof n=="string"?{chainId:o,isRaw:!1,message:n,originalMessage:l}:{chainId:o,isRaw:!0,message:typeof n.raw=="string"?n.raw:R(n.raw),originalMessage:l},{signature:w}=await we({client:e,payload:u,storage:t});return w},async signTransaction(n){if(!n.chainId)throw new Error("chainId required in tx to sign");return c({chainId:n.chainId,...n})},async signTypedData(n){const l=j(n),{signature:o}=await ge({client:e,payload:l,storage:t});return o},sendCalls:async n=>{const{inAppWalletSendCalls:l}=await I(async()=>{const{inAppWalletSendCalls:y}=await import("./in-app-wallet-calls-DKYLOsJB.js");return{inAppWalletSendCalls:y}},__vite__mapDeps([7,1,2,3,4,5,6,8])),o=n.calls[0];if(!o)throw new Error("No calls to send");const u=o.client,w=o.chain||n.chain,g=await l({account:s,calls:n.calls,chain:w});return{chain:w,client:u,id:g}},getCallsStatus:async n=>{const{inAppWalletGetCallsStatus:l}=await I(async()=>{const{inAppWalletGetCallsStatus:o}=await import("./in-app-wallet-calls-DKYLOsJB.js");return{inAppWalletGetCallsStatus:o}},__vite__mapDeps([7,1,2,3,4,5,6,8]));return l(n)},getCapabilities:async n=>({[n.chainId??1]:{atomic:{status:"unsupported"},paymasterService:{supported:!1}}})};return s}}function m(i){return i===void 0||G(i)?i:L(i)}const ye={backgroundColor:"transparent",border:"none",colorScheme:"light",display:"none",height:"100%",pointerEvents:"all",position:"fixed",right:"0px",top:"0px",width:"100%",zIndex:"2147483646"},T=new Map;class fe{constructor({link:e,baseUrl:t,iframeId:a,container:r,onIframeInitialize:c,localStorage:s,clientId:n,ecosystem:l}){if(Object.defineProperty(this,"iframe",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"POLLING_INTERVAL_SECONDS",{enumerable:!0,configurable:!0,writable:!0,value:1.4}),Object.defineProperty(this,"iframeBaseUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.localStorage=s,this.clientId=n,this.ecosystem=l,this.iframeBaseUrl=t,typeof document>"u")return;r=r??document.body;let o=document.getElementById(a);const u=new URL(e);if(!o||o.src!==u.href){o=document.createElement("iframe");const w={...ye};Object.assign(o.style,w),o.setAttribute("id",a),o.setAttribute("fetchpriority","high"),r.appendChild(o),o.src=u.href;const g=y=>{if(y.data.eventType==="ewsIframeLoaded"){if(window.removeEventListener("message",g),!o){console.warn("thirdweb iFrame not found");return}this.onIframeLoadHandler(o,c)()}};window.addEventListener("message",g)}this.iframe=o}async onIframeLoadedInitVariables(){return{authCookie:await this.localStorage.getAuthCookie(),clientId:this.clientId,deviceShareStored:await this.localStorage.getDeviceShare(),ecosystemId:this.ecosystem?.id,partnerId:this.ecosystem?.partnerId,walletUserId:await this.localStorage.getWalletUserId()}}onIframeLoadHandler(e,t){return async()=>{const a=new MessageChannel,r=new Promise((c,s)=>{a.port1.onmessage=n=>{const{data:l}=n;a.port1.close(),l.success||s(new Error(l.error)),T.set(e.src,!0),t&&t(),c(!0)}});e?.contentWindow?.postMessage({data:await this.onIframeLoadedInitVariables(),eventType:"initIframe"},this.iframeBaseUrl,[a.port2]),await r}}async call({procedureName:e,params:t,showIframe:a=!1}){if(!this.iframe)throw new Error("Iframe not found. You are likely calling this from the backend where the DOM is not available.");for(;!T.get(this.iframe.src);)await k(this.POLLING_INTERVAL_SECONDS*1e3);a&&(this.iframe.style.display="block",await k(.005*1e3));const r=new MessageChannel,c=new Promise((s,n)=>{r.port1.onmessage=async l=>{const{data:o}=l;r.port1.close(),a&&(await k(.1*1e3),this.iframe&&(this.iframe.style.display="none")),o.success?s(o.data):n(new Error(o.error))}});return this.iframe.contentWindow?.postMessage({data:{...t,...await this.onIframeLoadedInitVariables()},eventType:e},this.iframeBaseUrl,[r.port2]),c}destroy(){this.iframe&&T.delete(this.iframe.src)}}class be extends fe{constructor({clientId:e,baseUrl:t,ecosystem:a}){super({baseUrl:t,clientId:e,container:typeof document>"u"?void 0:document.body,ecosystem:a,iframeId:ke+(a?.id||""),link:Ie({baseUrl:t,clientId:e,ecosystem:a,path:x}).href,localStorage:new $({clientId:e,ecosystem:a,storage:D})}),this.clientId=e,this.ecosystem=a}}function Ie({clientId:i,baseUrl:e,path:t,ecosystem:a,queryParams:r}){const c=new URL(`${t}`,e);if(r)for(const s of Object.keys(r))c.searchParams.set(s,r[s]?.toString()||"");return c.searchParams.set("clientId",i),a?.partnerId!==void 0&&c.searchParams.set("partnerId",a.partnerId),a?.id!==void 0&&c.searchParams.set("ecosystemId",a.id),c}const ke="thirdweb-in-app-wallet-iframe";async function ve({client:i,ecosystem:e,authToken:t}){const r=await d(i,e)(`${p("inAppWallet")}/api/v1/enclave-wallet/generate`,{headers:{Authorization:`Bearer embedded-wallet-token:${t}`,"Content-Type":"application/json","x-thirdweb-client-id":i.clientId},method:"POST"});if(!r.ok)throw new Error(`Failed to generate wallet - ${r.status} ${r.statusText}`);const{wallet:c}=await r.json();return c}class Te{constructor({baseUrl:e,querier:t,preLogin:a,postLogin:r,client:c,ecosystem:s}){Object.defineProperty(this,"LoginQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"preLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"postLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"baseUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.baseUrl=e,this.LoginQuerier=t,this.preLogin=a,this.postLogin=r,this.client=c,this.ecosystem=s}async sendEmailLoginOtp({email:e}){return await this.LoginQuerier.call({params:{email:e},procedureName:"sendThirdwebEmailLoginOtp"})}async sendSmsLoginOtp({phoneNumber:e}){return await this.LoginQuerier.call({params:{phoneNumber:e},procedureName:"sendThirdwebSmsLoginOtp"})}}class Ae extends Te{async authenticateWithModal(){return this.LoginQuerier.call({params:void 0,procedureName:"loginWithThirdwebModal",showIframe:!0})}async loginWithModal(){await this.preLogin();const e=await this.authenticateWithModal();return this.postLogin(e)}async authenticateWithIframe({email:e}){return this.LoginQuerier.call({params:{email:e},procedureName:"loginWithThirdwebModal",showIframe:!0})}async loginWithIframe({email:e}){await this.preLogin();const t=await this.authenticateWithIframe({email:e});return this.postLogin(t)}async authenticateWithCustomJwt({encryptionKey:e,jwt:t}){if(!e||e.length===0)throw new Error("Encryption key is required for custom jwt auth");return this.LoginQuerier.call({params:{encryptionKey:e,jwt:t},procedureName:"loginWithCustomJwt"})}async loginWithCustomJwt({encryptionKey:e,jwt:t}){if(!e||e.length===0)throw new Error("Encryption key is required for custom jwt auth");await this.preLogin();const a=await this.authenticateWithCustomJwt({encryptionKey:e,jwt:t});return this.postLogin(a)}async authenticateWithCustomAuthEndpoint({encryptionKey:e,payload:t}){return this.LoginQuerier.call({params:{encryptionKey:e,payload:t},procedureName:"loginWithCustomAuthEndpoint"})}async loginWithCustomAuthEndpoint({encryptionKey:e,payload:t}){if(!e||e.length===0)throw new Error("Encryption key is required for custom auth");await this.preLogin();const a=await this.authenticateWithCustomAuthEndpoint({encryptionKey:e,payload:t});return this.postLogin(a)}async authenticateWithEmailOtp({email:e,otp:t,recoveryCode:a}){return this.LoginQuerier.call({params:{email:e,otp:t,recoveryCode:a},procedureName:"verifyThirdwebEmailLoginOtp"})}async loginWithEmailOtp({email:e,otp:t,recoveryCode:a}){const r=await this.authenticateWithEmailOtp({email:e,otp:t,recoveryCode:a});return this.postLogin(r)}async authenticateWithSmsOtp({phoneNumber:e,otp:t,recoveryCode:a}){return this.LoginQuerier.call({params:{otp:t,phoneNumber:e,recoveryCode:a},procedureName:"verifyThirdwebSmsLoginOtp"})}async loginWithSmsOtp({phoneNumber:e,otp:t,recoveryCode:a}){const r=await this.authenticateWithSmsOtp({otp:t,phoneNumber:e,recoveryCode:a});return this.postLogin(r)}}class Le{constructor({client:e,querier:t,onAuthSuccess:a,ecosystem:r,baseUrl:c,localStorage:s}){Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"AuthQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onAuthSuccess",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"BaseLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=e,this.ecosystem=r,this.AuthQuerier=t,this.localStorage=s,this.onAuthSuccess=a,this.BaseLogin=new Ae({baseUrl:c,client:e,ecosystem:r,postLogin:async n=>this.postLogin(n),preLogin:async()=>{await this.preLogin()},querier:t})}async preLogin(){await this.logout()}async postLogin({storedToken:e,walletDetails:t}){return e.shouldStoreCookieString&&await this.localStorage.saveAuthCookie(e.cookieString),await this.onAuthSuccess({storedToken:e,walletDetails:t})}async loginWithAuthToken(e,t){e.storedToken.authProvider!=="Backend"&&await this.preLogin();const a=await W({authToken:e.storedToken.cookieString,client:this.client,ecosystem:this.ecosystem});if(!a)throw new Error("Cannot login, no user found for auth token");if(a.wallets.length>0&&a.wallets[0]?.type==="enclave")return this.postLogin({storedToken:e.storedToken,walletDetails:{walletAddress:a.wallets[0].address}});if(a.wallets.length===0){const c=await ve({authToken:e.storedToken.cookieString,client:this.client,ecosystem:this.ecosystem});return this.postLogin({storedToken:e.storedToken,walletDetails:{walletAddress:c.address}})}const r=await this.AuthQuerier.call({params:{recoveryCode:t,storedToken:e.storedToken},procedureName:"loginWithStoredTokenDetails"});return this.postLogin(r)}async loginWithModal(){return this.BaseLogin.loginWithModal()}async authenticateWithModal(){return this.BaseLogin.authenticateWithModal()}async loginWithIframe(e){return this.BaseLogin.loginWithIframe(e)}async authenticateWithIframe(e){return this.BaseLogin.authenticateWithIframe(e)}async loginWithCustomJwt(e){return this.BaseLogin.loginWithCustomJwt(e)}async authenticateWithCustomJwt(e){return this.BaseLogin.authenticateWithCustomJwt(e)}async loginWithCustomAuthEndpoint(e){return this.BaseLogin.loginWithCustomAuthEndpoint(e)}async authenticateWithCustomAuthEndpoint(e){return this.BaseLogin.authenticateWithCustomAuthEndpoint(e)}async sendEmailLoginOtp({email:e}){return this.BaseLogin.sendEmailLoginOtp({email:e})}async sendSmsLoginOtp({phoneNumber:e}){return this.BaseLogin.sendSmsLoginOtp({phoneNumber:e})}async loginWithEmailOtp(e){return await this.preLogin(),this.BaseLogin.loginWithEmailOtp(e)}async authenticateWithEmailOtp(e){return this.BaseLogin.authenticateWithEmailOtp(e)}async loginWithSmsOtp(e){return await this.preLogin(),this.BaseLogin.loginWithSmsOtp(e)}async authenticateWithSmsOtp(e){return this.BaseLogin.authenticateWithSmsOtp(e)}async logout(){const e=await this.localStorage.removeAuthCookie(),t=await this.localStorage.removeWalletUserId();return{success:e||t}}}const Pe=async i=>{const{client:e,ecosystem:t}=i,a=P({authOption:i.strategy,client:e,ecosystem:t}),r={"Content-Type":"application/json","x-client-id":e.clientId};t?.id&&(r["x-ecosystem-id"]=t.id),t?.partnerId&&(r["x-ecosystem-partner-id"]=t.partnerId);const c=(()=>{switch(i.strategy){case"email":return{email:i.email};case"phone":return{phone:i.phoneNumber}}})(),s=await fetch(a,{body:h(c),headers:r,method:"POST"});if(!s.ok)throw new Error("Failed to send verification code");return await s.json()},C=async i=>{const{client:e,ecosystem:t}=i,a=S({authOption:i.strategy,client:i.client,ecosystem:i.ecosystem}),r={"Content-Type":"application/json","x-client-id":e.clientId};t?.id&&(r["x-ecosystem-id"]=t.id),t?.partnerId&&(r["x-ecosystem-partner-id"]=t.partnerId);const c=(()=>{switch(i.strategy){case"email":return{code:i.verificationCode,email:i.email};case"phone":return{code:i.verificationCode,phone:i.phoneNumber}}})(),s=await fetch(a,{body:h(c),headers:r,method:"POST"});if(!s.ok)throw new Error("Failed to verify verification code");return await s.json()};class O{constructor({client:e,ecosystem:t,querier:a,localStorage:r}){Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"walletManagerQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=e,this.ecosystem=t,this.walletManagerQuerier=a,this.localStorage=r}async postWalletSetUp(e){e.deviceShareStored&&await this.localStorage.saveDeviceShare(e.deviceShareStored,e.storedToken.authDetails.userWalletId)}async getUserWalletStatus(){const e=await this.walletManagerQuerier.call({params:void 0,procedureName:"getUserStatus"});return e.status==="Logged In, Wallet Initialized"?{status:"Logged In, Wallet Initialized",...e.user,account:await this.getAccount()}:e.status==="Logged In, New Device"?{status:"Logged In, New Device",...e.user}:e.status==="Logged In, Wallet Uninitialized"?{status:"Logged In, Wallet Uninitialized",...e.user}:{status:e.status}}async getAccount(){const e=this.walletManagerQuerier,t=this.client,a=this.ecosystem?.partnerId,{address:r}=await e.call({params:void 0,procedureName:"getAddress"}),c=async s=>{const n={chainId:s.chainId,data:s.data,gasLimit:s.gas,nonce:s.nonce,to:s.to??void 0,value:s.value};s.maxFeePerGas?(n.accessList=s.accessList,n.maxFeePerGas=s.maxFeePerGas,n.maxPriorityFeePerGas=s.maxPriorityFeePerGas,n.type=2):(n.gasPrice=s.gasPrice,n.type=0);const l=E().rpc,{signedTransaction:o}=await e.call({params:{chainId:s.chainId,partnerId:a,rpcEndpoint:`https://${s.chainId}.${l}`,transaction:n},procedureName:"signTransaction"});return o};return{address:f(r),async sendTransaction(s){const n=A({chain:b(s.chainId),client:t}),l=await c(s),o=await F(n,l);return _({chainId:s.chainId,client:t,contractAddress:s.to??void 0,gasPrice:s.gasPrice,transactionHash:o,walletAddress:r,walletType:"inApp"}),{transactionHash:o}},async signMessage({message:s}){const n=typeof s=="string"?s:s.raw instanceof Uint8Array?s.raw:Q(s.raw),{signedMessage:l}=await e.call({params:{chainId:1,message:n,partnerId:a},procedureName:"signMessage"});return l},async signTransaction(s){if(!s.chainId)throw new Error("chainId required in tx to sign");return c({...s,chainId:s.chainId})},async signTypedData(s){const n=j(s);n.types?.EIP712Domain&&(n.types.EIP712Domain=void 0);const l=n.domain,o=l?.chainId,w={...l?.verifyingContract?{verifyingContract:l?.verifyingContract}:{},name:l?.name,version:l?.version};o&&(w.chainId=o);const g=E().rpc,{signedTypedData:y}=await e.call({params:{chainId:Number.parseInt(BigInt(o||1).toString()),domain:w,message:n.message,partnerId:a,rpcEndpoint:`https://${o}.${g}`,types:n.types},procedureName:"signTypedDataV4"});return y}}}}class Fe{isClientIdLegacyPaper(e){return e.indexOf("-")>0&&e.length===36}constructor({client:e,onAuthSuccess:t,ecosystem:a,passkeyDomain:r,storage:c}){if(Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"querier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"storage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"wallet",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"auth",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"passkeyDomain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.isClientIdLegacyPaper(e.clientId))throw new Error("You are using a legacy clientId. Please use the clientId found on the thirdweb dashboard settings page");const s=p("inAppWallet");this.client=e,this.ecosystem=a,this.passkeyDomain=r,this.storage=new $({clientId:e.clientId,ecosystem:a,storage:c??We()}),this.querier=new be({baseUrl:s,clientId:e.clientId,ecosystem:a}),this.auth=new Le({baseUrl:s,client:e,ecosystem:a,localStorage:this.storage,onAuthSuccess:async n=>{if(t?.(n),n.storedToken.authDetails.walletType==="sharded"&&(await this.querier.call({params:{storedToken:n.storedToken},procedureName:"migrateFromShardToEnclave"})||console.warn("Failed to migrate from sharded to enclave wallet, continuing with sharded wallet")),this.wallet=await this.initializeWallet(n.storedToken.cookieString),!this.wallet)throw new Error("Failed to initialize wallet");const l="deviceShareStored"in n.walletDetails?n.walletDetails.deviceShareStored:void 0;return await this.wallet.postWalletSetUp({deviceShareStored:l,storedToken:n.storedToken}),this.wallet instanceof O&&await this.querier.call({params:{authCookie:n.storedToken.cookieString,clientId:this.client.clientId,deviceShareStored:"deviceShareStored"in n.walletDetails?n.walletDetails.deviceShareStored:null,ecosystemId:a?.id,partnerId:a?.partnerId,walletUserId:n.storedToken.authDetails.userWalletId},procedureName:"initIframe"}),{user:{account:await this.wallet.getAccount(),authDetails:n.storedToken.authDetails,status:"Logged In, Wallet Initialized",walletAddress:n.walletDetails.walletAddress}}},querier:this.querier})}async initializeWallet(e){const t=await this.storage.getAuthCookie();if(!e&&t===null)throw new Error("No auth token provided and no stored auth token found to initialize the wallet");const a=await W({authToken:e||t,client:this.client,ecosystem:this.ecosystem});if(!a)throw new Error("Cannot initialize wallet, no user logged in");if(a.wallets.length===0)throw new Error("Cannot initialize wallet, this user does not have a wallet generated yet");return a.wallets[0]?.type==="enclave"?new me({address:a.wallets[0].address,client:this.client,ecosystem:this.ecosystem,storage:this.storage}):new O({client:this.client,ecosystem:this.ecosystem,localStorage:this.storage,querier:this.querier})}async getUser(){if(!this.wallet){const e=await this.storage.getAuthCookie();if(!e)return{status:"Logged Out"};this.wallet=await this.initializeWallet(e)}if(!this.wallet)throw new Error("Wallet not initialized");return await this.wallet.getUserWalletStatus()}getAccount(){if(!this.wallet)throw new Error("Wallet not initialized");return this.wallet.getAccount()}async preAuthenticate(e){return Pe({...e,client:this.client,ecosystem:this.ecosystem})}async authenticateWithRedirect(e,t,a){return q({authOption:e,client:this.client,ecosystem:this.ecosystem,mode:t,redirectUrl:a})}async loginWithAuthToken(e,t){return this.auth.loginWithAuthToken(e,t)}async authenticate(e){const t=e.strategy;switch(t){case"email":return C({...e,client:this.client,ecosystem:this.ecosystem});case"phone":return C({...e,client:this.client,ecosystem:this.ecosystem});case"auth_endpoint":return ee({client:this.client,ecosystem:this.ecosystem,payload:e.payload});case"jwt":return ie({client:this.client,ecosystem:this.ecosystem,jwt:e.jwt});case"passkey":return this.passkeyAuth(e);case"iframe_email_verification":return this.auth.authenticateWithIframe({email:e.email});case"iframe":return this.auth.authenticateWithModal();case"apple":case"facebook":case"google":case"telegram":case"github":case"twitch":case"farcaster":case"line":case"x":case"tiktok":case"epic":case"steam":case"coinbase":case"discord":return V({authOption:t,client:this.client,closeOpenedWindow:e.closeOpenedWindow,ecosystem:this.ecosystem,openedWindow:e.openedWindow});case"guest":return ae({client:this.client,ecosystem:this.ecosystem,storage:this.storage});case"backend":return te({client:this.client,ecosystem:this.ecosystem,walletSecret:e.walletSecret});case"wallet":return de({client:this.client,ecosystem:this.ecosystem,wallet:e.wallet,chain:e.chain})}}async connect(e){const t=e.strategy;switch(t){case"auth_endpoint":case"jwt":{const a=await this.authenticate(e);return await this.loginWithAuthToken(a,e.encryptionKey)}case"iframe_email_verification":return this.auth.loginWithIframe({email:e.email});case"iframe":return this.auth.loginWithModal();case"passkey":{const a=await this.passkeyAuth(e);return this.loginWithAuthToken(a)}case"backend":case"phone":case"email":case"wallet":case"apple":case"facebook":case"google":case"farcaster":case"telegram":case"github":case"line":case"x":case"tiktok":case"epic":case"guest":case"coinbase":case"twitch":case"steam":case"discord":{const a=await this.authenticate(e);return await this.auth.loginWithAuthToken(a)}default:Se(t)}}async logout(){return await this.auth.logout()}async passkeyAuth(e){const{PasskeyWebClient:t}=await I(async()=>{const{PasskeyWebClient:n}=await import("./index-Bbs9zcGG.js").then(l=>l.ec);return{PasskeyWebClient:n}},__vite__mapDeps([1,2,3,4,5,6])),{passkeyName:a,storeLastUsedPasskey:r=!0}=e,c=new t,s=this.storage;return e.type==="sign-up"?oe({client:this.client,ecosystem:this.ecosystem,passkeyClient:c,rp:{id:this.passkeyDomain??window.location.hostname,name:this.passkeyDomain??window.document.title},storage:r?s:void 0,username:a}):ce({client:this.client,ecosystem:this.ecosystem,passkeyClient:c,rp:{id:this.passkeyDomain??window.location.hostname,name:this.passkeyDomain??window.document.title},storage:r?s:void 0})}async linkProfile(e){const{storedToken:t}=await this.authenticate(e);return await ne({client:e.client,ecosystem:e.ecosystem||this.ecosystem,storage:this.storage,tokenToLink:t.cookieString})}async unlinkProfile(e,t){return await se({allowAccountDeletion:t,client:this.client,ecosystem:this.ecosystem,profileToUnlink:e,storage:this.storage})}async getProfiles(){return re({client:this.client,ecosystem:this.ecosystem,storage:this.storage})}}function Se(i,e){throw new Error(`Invalid param: ${i}`)}function We(){return typeof window<"u"&&window.localStorage?D:J}export{Fe as InAppWebConnector};
//# sourceMappingURL=web-connector-DYNuAmEW.js.map
