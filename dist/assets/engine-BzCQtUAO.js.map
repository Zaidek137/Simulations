{"version":3,"file":"engine-BzCQtUAO.js","sources":["../../node_modules/thirdweb/dist/esm/transaction/actions/gasless/providers/engine.js"],"sourcesContent":["import { getContract } from \"../../../../contract/contract.js\";\nimport { stringify } from \"../../../../utils/json.js\";\nimport { readContract } from \"../../../read-contract.js\";\nimport { waitForReceipt, } from \"../../wait-for-tx-receipt.js\";\n/**\n * @internal - only exported for testing\n */\nexport async function prepareEngineTransaction({ account, serializableTransaction, transaction, gasless, }) {\n    const forrwaderContract = getContract({\n        address: gasless.relayerForwarderAddress,\n        chain: transaction.chain,\n        client: transaction.client,\n    });\n    const nonce = await readContract({\n        contract: forrwaderContract,\n        method: \"function getNonce(address) view returns (uint256)\",\n        params: [account.address],\n    });\n    const [signature, message] = await (async () => {\n        // TODO: handle special case for `approve` -> `permit` transactions\n        if (!serializableTransaction.to) {\n            throw new Error(\"engine transactions must have a 'to' address\");\n        }\n        if (!serializableTransaction.gas) {\n            throw new Error(\"engine transactions must have a 'gas' value\");\n        }\n        if (!serializableTransaction.data) {\n            throw new Error(\"engine transactions must have a 'data' value\");\n        }\n        // chainless support!\n        if (gasless.experimentalChainlessSupport) {\n            const message = {\n                chainid: BigInt(transaction.chain.id),\n                data: serializableTransaction.data,\n                from: account.address,\n                gas: serializableTransaction.gas,\n                nonce: nonce,\n                to: serializableTransaction.to,\n                value: 0n,\n            };\n            return [\n                await account.signTypedData({\n                    domain: {\n                        name: \"GSNv2 Forwarder\",\n                        verifyingContract: forrwaderContract.address,\n                        version: \"0.0.1\",\n                    },\n                    message,\n                    primaryType: \"ForwardRequest\",\n                    types: { ForwardRequest: ChainAwareForwardRequest },\n                }),\n                message,\n            ];\n        }\n        // else non-chainless support\n        const message = {\n            data: serializableTransaction.data,\n            from: account.address,\n            gas: serializableTransaction.gas,\n            nonce: nonce,\n            to: serializableTransaction.to,\n            value: 0n,\n        };\n        return [\n            await account.signTypedData({\n                domain: {\n                    chainId: transaction.chain.id,\n                    name: gasless.domainName ?? \"GSNv2 Forwarder\",\n                    verifyingContract: forrwaderContract.address,\n                    version: gasless.domainVersion ?? \"0.0.1\",\n                },\n                message,\n                primaryType: \"ForwardRequest\",\n                types: { ForwardRequest },\n            }),\n            message,\n        ];\n    })();\n    // TODO: handle special case for `approve` -> `permit`\n    const messageType = \"forward\";\n    return { message, messageType, signature };\n}\nconst ForwardRequest = [\n    { name: \"from\", type: \"address\" },\n    { name: \"to\", type: \"address\" },\n    { name: \"value\", type: \"uint256\" },\n    { name: \"gas\", type: \"uint256\" },\n    { name: \"nonce\", type: \"uint256\" },\n    { name: \"data\", type: \"bytes\" },\n];\nconst ChainAwareForwardRequest = [\n    { name: \"from\", type: \"address\" },\n    { name: \"to\", type: \"address\" },\n    { name: \"value\", type: \"uint256\" },\n    { name: \"gas\", type: \"uint256\" },\n    { name: \"nonce\", type: \"uint256\" },\n    { name: \"data\", type: \"bytes\" },\n    { name: \"chainid\", type: \"uint256\" },\n];\n/**\n * @internal\n */\nexport async function relayEngineTransaction(options) {\n    const { message, messageType, signature } = await prepareEngineTransaction(options);\n    const response = await fetch(options.gasless.relayerUrl, {\n        body: stringify({\n            forwarderAddress: options.gasless.relayerForwarderAddress,\n            request: message,\n            signature,\n            type: messageType,\n        }),\n        headers: {\n            \"Content-Type\": \"application/json\",\n        },\n        method: \"POST\",\n    });\n    if (!response.ok) {\n        throw new Error(`Failed to send transaction: ${await response.text()}`);\n    }\n    const json = await response.json();\n    if (!json.result) {\n        throw new Error(`Relay transaction failed: ${json.message}`);\n    }\n    const queueId = json.result.queueId;\n    // poll for transactionHash\n    const timeout = 60000;\n    const interval = 1000;\n    const endtime = Date.now() + timeout;\n    while (Date.now() < endtime) {\n        const receipt = await fetchReceipt({ options, queueId });\n        if (receipt) {\n            return {\n                chain: options.transaction.chain,\n                client: options.transaction.client,\n                transactionHash: receipt.transactionHash,\n            };\n        }\n        await new Promise((resolve) => setTimeout(resolve, interval));\n    }\n    throw new Error(`Failed to find relayed transaction after ${timeout}ms`);\n}\nasync function fetchReceipt(args) {\n    const { options, queueId } = args;\n    const url = options.gasless.relayerUrl.split(\"/relayer/\")[0];\n    const res = await fetch(`${url}/transaction/status/${queueId}`, {\n        method: \"GET\",\n    });\n    const resJson = await res.json();\n    if (!res.ok) {\n        return null;\n    }\n    const result = resJson.result;\n    if (!result) {\n        return null;\n    }\n    switch (result.status) {\n        case \"errored\":\n            throw new Error(`Transaction errored with reason: ${result.errorMessage}`);\n        case \"cancelled\":\n            throw new Error(\"Transaction execution cancelled.\");\n        case \"mined\": {\n            const receipt = await waitForReceipt({\n                chain: options.transaction.chain,\n                client: options.transaction.client,\n                transactionHash: result.transactionHash,\n            });\n            return receipt;\n        }\n        default: {\n            return null;\n        }\n    }\n}\n//# sourceMappingURL=engine.js.map"],"names":["prepareEngineTransaction","account","serializableTransaction","transaction","gasless","forrwaderContract","getContract","nonce","readContract","signature","message","ChainAwareForwardRequest","ForwardRequest","relayEngineTransaction","options","messageType","response","stringify","json","queueId","timeout","interval","endtime","receipt","fetchReceipt","resolve","args","url","res","resJson","result","waitForReceipt"],"mappings":"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","x_google_ignoreList":[0]}